<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">الشروق لمواد البناء - حاسبة الرسوم للمتجر</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4C8FF0">
    <link rel="apple-touch-icon" href="https://www2.0zz0.com/2025/04/29/23/183916568.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://www2.0zz0.com/2025/04/29/23/183916568.png" type="image/png">
    <style>
        /* ==========================================================================
           1. CSS Variables & Theme Definitions
           ========================================================================== */
        :root { /* ... Variables Unchanged ... */ --font-primary: 'Tajawal', sans-serif; --clr-primary-hue: 210; --clr-primary-saturation: 75%; --clr-primary-lightness-light: 55%; --clr-primary-lightness-dark: 45%; --clr-primary-light: hsl(var(--clr-primary-hue), var(--clr-primary-saturation), var(--clr-primary-lightness-light)); --clr-primary-dark: hsl(var(--clr-primary-hue), var(--clr-primary-saturation), var(--clr-primary-lightness-dark)); --clr-primary-hover-light: hsl(var(--clr-primary-hue), var(--clr-primary-saturation), 50%); --clr-primary-hover-dark: hsl(var(--clr-primary-hue), var(--clr-primary-saturation), 40%); --clr-primary-focus-ring-light: hsla(var(--clr-primary-hue), var(--clr-primary-saturation), 50%, 0.35); --clr-primary-focus-ring-dark: hsla(var(--clr-primary-hue), var(--clr-primary-saturation), 60%, 0.4); --clr-gray-50: #f9fafb; --clr-gray-100: #f3f4f6; --clr-gray-200: #e5e7eb; --clr-gray-300: #d1d5db; --clr-gray-400: #9ca3af; --clr-gray-500: #6b7280; --clr-gray-600: #4b5563; --clr-gray-700: #374151; --clr-gray-800: #1f2937; --clr-gray-900: #111827; --clr-gray-950: #0c101b; --clr-warm-white: hsl(36, 30%, 98%); --clr-soft-beige: hsl(36, 25%, 95%); --clr-warm-border: hsl(36, 20%, 88%); --clr-success: #10b981; --clr-warning: #ef4444; --clr-success-dark: #34d399; --clr-warning-dark: #f87171; --clr-white: #ffffff; --clr-black: #000000; --font-size-xs: 0.75rem; --font-size-sm: 0.875rem; --font-size-base: 1rem; --font-size-md: 1.125rem; --font-size-lg: 1.25rem; --font-size-xl: 1.5rem; --font-size-xxl: 1.75rem; --line-height-base: 1.6; --line-height-tight: 1.3; --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem; --space-5: 1.25rem; --space-6: 1.5rem; --space-7: 1.75rem; --space-8: 2rem; --space-9: 2.5rem; --space-10: 3rem; --space-11: 3.5rem; --space-12: 4rem; --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --border-width: 1px; --focus-ring-width: 3px; --shadow-color-light: rgba(90, 70, 50, 0.07); --shadow-color-md-light: rgba(90, 70, 50, 0.09); --shadow-color-lg-light: rgba(90, 70, 50, 0.11); --shadow-color-dark: rgba(0, 0, 0, 0.16); --shadow-color-md-dark: rgba(0, 0, 0, 0.25); --shadow-color-lg-dark: rgba(0, 0, 0, 0.35); --shadow-sm-light: 0 1px 2px var(--shadow-color-light); --shadow-md-light: 0 3px 5px var(--shadow-color-md-light), 0 1px 2px var(--shadow-color-light); --shadow-lg-light: 0 6px 10px var(--shadow-color-lg-light), 0 2px 4px var(--shadow-color-md-light); --shadow-sm-dark: 0 1px 2px var(--shadow-color-dark); --shadow-md-dark: 0 3px 5px var(--shadow-color-md-dark), 0 1px 2px var(--shadow-color-dark); --shadow-lg-dark: 0 6px 10px var(--shadow-color-lg-dark), 0 2px 4px var(--shadow-color-md-dark); --transition-duration: 0.25s; --transition-timing: cubic-bezier(0.4, 0, 0.2, 1); --transition-base: var(--transition-duration) var(--transition-timing); --details-animation-duration: 0.3s; --details-stagger-delay: 0.05s; }
        [data-theme="light"] { /* Theme variables */ --clr-primary-current: var(--clr-primary-light); --clr-primary-hover-current: var(--clr-primary-hover-light); --clr-primary-focus-ring-current: var(--clr-primary-focus-ring-light); --clr-bg-current: var(--clr-soft-beige); --clr-surface-current: var(--clr-warm-white); --clr-input-bg-current: var(--clr-warm-white); --clr-text-current: var(--clr-gray-900); --clr-text-muted-current: var(--clr-gray-600); --clr-border-current: var(--clr-warm-border); --clr-input-border-current: var(--clr-gray-300); --clr-input-focus-border-current: var(--clr-primary-light); --clr-success-current: var(--clr-success); --clr-warning-current: var(--clr-warning); --shadow-sm-current: var(--shadow-sm-light); --shadow-md-current: var(--shadow-md-light); --shadow-lg-current: var(--shadow-lg-light); --note-bg-current: color-mix(in srgb, var(--clr-primary-light) 5%, transparent); --note-border-current: color-mix(in srgb, var(--clr-primary-light) 20%, transparent); --viz-bar-profit-bg: hsl(var(--clr-primary-hue), 60%, 88%); --viz-bar-fee-bg: hsl(var(--clr-primary-hue), 20%, 92%); --details-bg: hsl(var(--clr-primary-hue), 20%, 96%); --separator-color: hsla(var(--clr-primary-hue), 15%, 50%, 0.15); --control-border-current: var(--clr-gray-300); --sidebar-desktop-bg: var(--clr-surface-current); --input-wrapper-bg: var(--clr-input-bg-current); --input-wrapper-border: var(--clr-input-border-current); --input-wrapper-focus-border: var(--clr-input-focus-border-current); --input-wrapper-focus-shadow: var(--clr-primary-focus-ring-light); --toggle-details-text-color: var(--clr-primary-current); --toggle-details-hover-bg: color-mix(in srgb, var(--clr-primary-light) 10%, transparent); --clear-btn-color: var(--clr-gray-600); --clear-btn-border-color: var(--clr-gray-300); --clear-btn-disabled-color: var(--clr-gray-400); --result-item-bg: color-mix(in srgb, var(--clr-surface-current) 95%, var(--clr-bg-current)); --result-item-border: var(--separator-color); --result-item-hover-bg: color-mix(in srgb, black 4%, var(--result-item-bg)); --result-item-inset-shadow: inset 0 1px 2px rgba(90, 70, 50, 0.06); --detail-calc-text-color: var(--clr-gray-700); --detail-calc-code-bg: color-mix(in srgb, var(--clr-border-current) 30%, transparent); }
        [data-theme="dark"] { /* Theme variables */ --clr-primary-current: var(--clr-primary-dark); --clr-primary-hover-current: var(--clr-primary-hover-dark); --clr-primary-focus-ring-current: var(--clr-primary-focus-ring-dark); --clr-bg-current: var(--clr-gray-950); --clr-surface-current: var(--clr-gray-900); --clr-input-bg-current: var(--clr-gray-800); --clr-text-current: var(--clr-gray-100); --clr-text-muted-current: var(--clr-gray-400); --clr-border-current: var(--clr-gray-700); --clr-input-border-current: var(--clr-gray-700); --clr-input-focus-border-current: var(--clr-primary-dark); --clr-success-current: var(--clr-success-dark); --clr-warning-current: var(--clr-warning-dark); --shadow-sm-current: var(--shadow-sm-dark); --shadow-md-current: var(--shadow-md-dark); --shadow-lg-current: var(--shadow-lg-dark); --note-bg-current: color-mix(in srgb, var(--clr-primary-dark) 15%, #00000080); --note-border-current: color-mix(in srgb, var(--clr-primary-dark) 30%, transparent); --viz-bar-profit-bg: hsl(var(--clr-primary-hue), 30%, 35%); --viz-bar-fee-bg: hsl(var(--clr-primary-hue), 20%, 25%); --details-bg: hsl(var(--clr-primary-hue), 15%, 22%); --separator-color: hsla(var(--clr-primary-hue), 10%, 80%, 0.1); --control-border-current: var(--clr-gray-600); --sidebar-desktop-bg: color-mix(in srgb, var(--clr-surface-current) 95%, black 5%); --input-wrapper-bg: var(--clr-input-bg-current); --input-wrapper-border: var(--clr-input-border-current); --input-wrapper-focus-border: var(--clr-input-focus-border-current); --input-wrapper-focus-shadow: var(--clr-primary-focus-ring-dark); --toggle-details-text-color: var(--clr-primary-current); --toggle-details-hover-bg: color-mix(in srgb, var(--clr-primary-dark) 15%, transparent); --clear-btn-color: var(--clr-gray-400); --clear-btn-border-color: var(--clr-gray-700); --clear-btn-disabled-color: var(--clr-gray-600); --result-item-bg: color-mix(in srgb, var(--clr-surface-current) 95%, var(--clr-bg-current)); --result-item-border: var(--separator-color); --result-item-hover-bg: color-mix(in srgb, var(--clr-primary-current) 6%, var(--result-item-bg)); --result-item-inset-shadow: inset 0 1px 3px hsla(0, 0%, 0%, 0.25); --detail-calc-text-color: var(--clr-text-muted-current); --detail-calc-code-bg: color-mix(in srgb, var(--clr-border-current) 40%, transparent); }

        /* ==========================================================================
           2. Base & Reset Styles
           ========================================================================== */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 100%; -webkit-tap-highlight-color: transparent; height: 100%; }
        body { font-family: var(--font-primary); background: var(--clr-bg-current); color: var(--clr-text-current); min-height: 100%; display: flex; flex-direction: column; transition: background var(--transition-base), color var(--transition-base); line-height: var(--line-height-base); font-size: var(--font-size-base); overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        img { max-width: 100%; height: auto; display: block; vertical-align: middle; }
        svg { width: 1em; height: 1em; display: block; }
        button { background: none; border: none; padding: 0; margin: 0; font: inherit; color: inherit; cursor: pointer; text-align: inherit; -webkit-appearance: none; appearance: none;}
        input[type="text"] { font-family: inherit; font-size: inherit; line-height: inherit; color: inherit; border: none; background-color: transparent; padding: 0; border-radius: 0; -webkit-appearance: none; appearance: none; outline: none; }

        /* ==========================================================================
           3. Utility Classes
           ========================================================================== */
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* ==========================================================================
           4. Animations
           ========================================================================== */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        *:focus-visible { transition: box-shadow 0.15s ease-out; }
        @keyframes detailRowSlideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* No value update animation */

        /* ==========================================================================
           5. Layout Structure
           ========================================================================== */
        .page-wrapper { position: relative; width: 100%; flex-grow: 1; display: flex; flex-direction: column; animation: fadeIn 0.5s var(--transition-timing); min-height: 100vh; }
        .main-container { width: 100%; max-width: 1440px; margin: var(--space-6) auto; padding: 0 var(--space-4); display: flex; flex-direction: column; gap: var(--space-6); margin-bottom: var(--space-8); flex-grow: 1; }
        .sidebar { flex-shrink: 0; animation: slideInUp 0.5s var(--transition-timing) 0.1s backwards; animation-play-state: paused; }
        .main-content-area { flex-grow: 1; min-width: 0; animation: slideInUp 0.5s var(--transition-timing) 0.2s backwards; animation-play-state: paused; display: flex; flex-direction: column; }
        .page-footer {
            text-align: center;
            padding: var(--space-3) var(--space-4) var(--space-5); /* Adjusted padding */
            margin-top: auto;
            font-size: var(--font-size-sm);
            color: var(--clr-text-muted-current);
            border-top: var(--border-width) solid var(--clr-border-current);
            background: var(--clr-surface-current);
            transition: background var(--transition-base), border-color var(--transition-base), color var(--transition-base);
            flex-shrink: 0;
        }

        /* ==========================================================================
           6. Sidebar Components
           ========================================================================== */
        .sidebar { background: var(--clr-surface-current); padding: var(--space-3); border-radius: var(--radius-lg); box-shadow: var(--shadow-md-current); border: var(--border-width) solid var(--clr-border-current); transition: background var(--transition-base), border-color var(--transition-base), box-shadow var(--transition-base); position: relative; display: flex; flex-direction: column; }
        .sidebar-header { padding-bottom: var(--space-4); margin-bottom: var(--space-4); border-bottom: var(--border-width) solid var(--clr-border-current); }
        .sidebar-logo-container { display: flex; justify-content: center; align-items: center; width: 65%; max-width: 200px; margin: 0 auto var(--space-4); padding: 0; border: none; }
        #storeLogo { height: auto; width: 100%; object-fit: contain; border-radius: var(--radius-sm); transition: transform var(--transition-base), filter var(--transition-base); }
        #storeLogo:hover { transform: scale(1.05); filter: brightness(1.1) drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }
        .controls { display: flex; align-items: center; justify-content: center; gap: var(--space-2); flex-wrap: wrap; margin: 0; }
        [dir="rtl"] .controls { flex-direction: row-reverse; }
        .control-btn { padding: var(--space-2); border: var(--border-width) solid var(--control-border-current); border-radius: var(--radius-md); background: transparent; color: var(--clr-text-muted-current); cursor: pointer; transition: transform var(--transition-base), box-shadow var(--transition-base), background-color var(--transition-base), border-color var(--transition-base), color var(--transition-base); font-size: var(--font-size-sm); font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-2); white-space: nowrap; min-width: 2.5rem; height: 2.5rem; position: relative; }
        .control-btn .btn-icon-wrapper { display: inline-flex; align-items: center; justify-content: center; width: 1.4em; height: 1.4em; }
        .control-btn .btn-icon-wrapper > svg { width: 100%; height: 100%; object-fit: contain; fill: none; stroke: currentColor; }
        .control-btn .btn-text { display: inline; font-weight: 500; }
        .control-btn:hover { border-color: var(--clr-primary-current); color: var(--clr-primary-current); background: color-mix(in srgb, var(--clr-primary-current) 8%, transparent); transform: translateY(-2px) scale(1.03); box-shadow: var(--shadow-sm-current); }
        .control-btn:active { transform: translateY(0px) scale(0.97); background: color-mix(in srgb, var(--clr-primary-current) 12%, transparent); }
        .control-btn:focus-visible { outline: none; border-color: var(--clr-primary-current); box-shadow: 0 0 0 var(--focus-ring-width) var(--clr-primary-focus-ring-current); }
        #btnShareWhatsapp .btn-icon-wrapper img { border-radius: 4px; }
        #btn-lang .btn-icon-wrapper { width: 1.2em; height: 1.2em; }
        #btn-lang .lang-text { font-weight: 500; }

        .sidebar-content-wrapper { display: flex; flex-direction: column; align-items: center; gap: var(--space-4); margin: 0; padding: 0; border: none; }
        .sidebar-title { font-size: var(--font-size-lg); font-weight: 700; color: var(--clr-primary-current); text-align: center; margin: 0 0 var(--space-1) 0; line-height: var(--line-height-tight); width: 100%; }
        label[for="price"] { display: block; text-align: center; font-size: var(--font-size-sm); font-weight: 500; color: var(--clr-text-muted-current); margin-bottom: var(--space-2); transition: color var(--transition-base); pointer-events: none; width: 100%; }
        .input-wrapper { position: relative; width: 100%; max-width: 420px; margin-inline: auto; display: grid; grid-template-columns: 1fr auto; gap: 0; align-items: stretch; background-color: var(--input-wrapper-bg); border: var(--border-width) solid var(--input-wrapper-border); border-radius: var(--radius-lg); transition: border-color var(--transition-base), box-shadow var(--transition-base); box-shadow: var(--shadow-sm-current) inset; overflow: hidden; }
        .input-wrapper:focus-within { border-color: var(--input-wrapper-focus-border); box-shadow: 0 0 0 var(--focus-ring-width) var(--input-wrapper-focus-shadow), var(--shadow-sm-current) inset; }
        .input-wrapper input#price { grid-column: 1 / 2; width: 100%; padding-block: var(--space-3); padding-inline: var(--space-4); font-size: var(--font-size-lg); font-weight: 700; line-height: var(--line-height-base); border: none; background: transparent; outline: none; text-align: center; color: var(--clr-text-current); border-radius: var(--radius-lg) 0 0 var(--radius-lg); [dir="rtl"] & { border-radius: 0 var(--radius-lg) var(--radius-lg) 0; } }
        .input-wrapper input#price::placeholder { color: var(--clr-text-muted-current); opacity: 0.6; font-weight: 400; }
        #btnClear { grid-column: 2 / 3; position: relative; inset: auto; flex-shrink: 0; width: 3.2rem; height: auto; padding: 0 var(--space-2); font-size: 1rem; background: transparent; border: none; border-radius: 0; color: var(--clear-btn-color); cursor: pointer; line-height: 0; display: flex; align-items: center; justify-content: center; border-inline-start: var(--border-width) solid var(--input-wrapper-border); opacity: 1; visibility: visible; transform: scale(1); transition: color var(--transition-base), background-color var(--transition-base), transform var(--transition-base), opacity var(--transition-base), border-color var(--transition-base); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        #btnClear svg { width: 1.15em; height: 1.15em; margin: 0; pointer-events: none; fill: none; stroke: currentColor; stroke-width: 1.5; }
        #btnClear:disabled { opacity: 0.4; cursor: not-allowed; background-color: transparent !important; color: var(--clear-btn-disabled-color); transform: scale(1); border-inline-start-color: var(--input-wrapper-border); }
        #btnClear:not(:disabled):hover { color: var(--clr-primary-current); background-color: color-mix(in srgb, var(--clr-primary-current) 10%, transparent); }
        #btnClear:not(:disabled):active { background-color: color-mix(in srgb, var(--clr-primary-current) 18%, transparent); transform: scale(0.95); }
        #btnClear:not(:disabled):focus-visible { color: var(--clr-primary-current); outline: none; box-shadow: inset 0 0 0 2px var(--clr-primary-focus-ring-current); background-color: color-mix(in srgb, var(--clr-primary-current) 5%, transparent); }
        [data-theme="dark"] #btnClear { border-inline-start-color: var(--clr-gray-700); }
        [data-theme="dark"] #btnClear:disabled { color: var(--clr-gray-600); border-inline-start-color: var(--clr-gray-700); }
        [data-theme="dark"] #btnClear:not(:disabled):hover { background-color: color-mix(in srgb, var(--clr-primary-current) 15%, var(--input-wrapper-bg)); }
        [data-theme="dark"] #btnClear:not(:disabled):active { background-color: color-mix(in srgb, var(--clr-primary-current) 25%, var(--input-wrapper-bg)); }
        [data-theme="dark"] #btnClear:not(:disabled):focus-visible { background-color: color-mix(in srgb, var(--clr-primary-current) 10%, var(--input-wrapper-bg)); }

        /* Fee Options Styling - Redesigned for better aesthetics and compactness */
        .fee-options-container {
            width: 100%;
            max-width: 420px;
            margin-inline: auto;
            margin-top: var(--space-3);
            padding: var(--space-3);
            background-color: var(--clr-surface-current);
            border: 1px solid var(--clr-border-current);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm-current);
        }
        .fee-options-container legend,
        .fee-options-container .toggle-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--clr-text-muted-current);
            margin-bottom: var(--space-2);
            text-align: center;
        }
        .provider-selection fieldset {
            border: none;
            padding: 0;
            margin: 0 0 var(--space-3) 0;
            display: flex;
            justify-content: space-around;
            gap: var(--space-2);
        }
        .provider-selection .provider-option {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-base), border-color var(--transition-base);
            cursor: pointer;
            flex: 1;
            justify-content: center;
        }
        .provider-selection .provider-option:hover {
            background-color: color-mix(in srgb, var(--clr-primary-current) 5%, transparent);
        }
        .provider-selection input[type="radio"]:checked + label {
            color: var(--clr-primary-current);
            font-weight: 700;
        }
        .provider-selection input[type="radio"] {
            accent-color: var(--clr-primary-current);
            width: 1.1em;
            height: 1.1em;
            cursor: pointer;
        }
        .provider-selection label {
            font-size: var(--font-size-sm);
            color: var(--clr-text-current);
            cursor: pointer;
        }
        .settlement-toggle-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-2);
            padding-top: var(--space-2);
            border-top: 1px solid var(--separator-color);
        }
         .settlement-toggle-wrapper .toggle-label {
            margin-bottom: 0;
            text-align: start;
            flex-grow: 1;
         }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--clr-gray-300); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--clr-primary-current); }
        input:focus + .slider { box-shadow: 0 0 1px var(--clr-primary-current); }
        input:checked + .slider:before { transform: translateX(22px); }
        [data-theme="dark"] .slider { background-color: var(--clr-gray-700); }
        [data-theme="dark"] input:checked + .slider { background-color: var(--clr-primary-current); }


        /* Collapsible FAQ Note Styling - Main container for the entire FAQ section */
        .note-faq-main-container {
            width: 100%;
            max-width: 420px;
            margin-inline: auto;
            margin-top: var(--space-3);
            border-radius: var(--radius-md);
            background-color: var(--note-bg-current);
            border: var(--border-width) solid var(--note-border-current);
            border-inline-start: 4px solid var(--clr-primary-current);
            overflow: hidden; /* For smooth collapse */
        }
        .note-faq-main-container > summary { /* Styling for the main toggle summary */
            padding: var(--space-2) var(--space-3);
            font-weight: 700;
            color: var(--clr-primary-current);
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-md); /* Larger font for main title */
        }
        .note-faq-main-container > summary::-webkit-details-marker { display: none; }
        .note-faq-main-container > summary::after {
            content: '▼';
            font-size: 0.8em;
            transition: transform 0.3s ease;
            margin-inline-start: var(--space-2);
        }
        .note-faq-main-container[open] > summary::after {
            transform: rotate(180deg);
        }
        .note-faq-content-wrapper { /* Wrapper for the inner FAQ items */
             padding: 0 var(--space-3) var(--space-2) var(--space-3); /* Padding for the inner content */
        }
        .note-faq-content-wrapper details { /* Styling for individual FAQ items */
            margin-bottom: var(--space-2);
            background-color: var(--clr-surface-current);
            border-radius: var(--radius-sm);
            border: 1px solid var(--separator-color);
            transition: background-color var(--transition-base);
            box-shadow: var(--shadow-sm-current);
        }
        .note-faq-content-wrapper details:last-child { margin-bottom: 0; }
        .note-faq-content-wrapper details[open] {
            background-color: color-mix(in srgb, var(--clr-primary-current) 4%, var(--clr-surface-current));
            box-shadow: var(--shadow-md-current);
        }
        .note-faq-content-wrapper summary { /* Styling for individual FAQ item summaries */
            padding: var(--space-2) var(--space-3);
            font-weight: 700;
            color: var(--clr-primary-current);
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            transition: background-color var(--transition-base);
            border-radius: var(--radius-sm);
        }
        .note-faq-content-wrapper summary:hover {
            background-color: color-mix(in srgb, var(--clr-primary-current) 8%, transparent);
        }
        .note-faq-content-wrapper summary::-webkit-details-marker { display: none; }
        .note-faq-content-wrapper summary::after {
            content: '▼';
            font-size: 0.8em;
            transition: transform 0.3s ease;
            margin-inline-start: var(--space-2);
            color: var(--clr-text-muted-current);
        }
        .note-faq-content-wrapper details[open] summary::after {
            transform: rotate(180deg);
            color: var(--clr-primary-current);
        }
        .note-faq-content { /* Styling for the content of individual FAQ items */
            padding: var(--space-1) var(--space-3) var(--space-3) var(--space-3);
            font-size: calc(var(--font-size-sm) * 0.92);
            line-height: var(--line-height-base);
            color: var(--clr-text-muted-current);
        }
        .note-faq-content strong { color: var(--clr-text-current); font-weight: 700; }
        .note-faq-content ul { padding-inline-start: var(--space-4); margin-top: var(--space-1); }
        .note-faq-content ul ul { margin-top: var(--space-1); padding-inline-start: var(--space-3); }
        .note-faq-content li { margin-bottom: var(--space-1); }


        /* ==========================================================================
           7. Main Content Area Components
           ========================================================================== */
        .card { background: var(--clr-surface-current); border: var(--border-width) solid var(--clr-border-current); border-radius: var(--radius-lg); padding: var(--space-3); transition: transform var(--transition-base), box-shadow var(--transition-base), border-color var(--transition-base); box-shadow: var(--shadow-md-current); display: flex; flex-direction: column; position: relative; overflow: hidden; flex-grow: 1; }
        .card:hover { box-shadow: var(--shadow-lg-current); transform: translateY(-3px); }
        .card-header { display: flex; flex-direction: column; align-items: center; gap: var(--space-2); margin-bottom: var(--space-4); padding-bottom: var(--space-3); border-bottom: var(--border-width) solid var(--clr-border-current); }
        .card-header h2 { font-size: var(--font-size-lg); font-weight: 700; color: var(--clr-text-current); line-height: var(--line-height-tight); margin: 0; text-align: center; order: 1; }
        .logos-container { display: flex; align-items: center; gap: var(--space-3); flex-shrink: 0; margin-inline-start: 0; order: 2; }
        .logos-container img { height: 30px; width: auto; object-fit: contain; border-radius: var(--radius-sm); background: var(--clr-white); padding: var(--space-1); box-shadow: var(--shadow-sm-current); transition: transform var(--transition-base), box-shadow var(--transition-base); }
        .logos-container img:hover { transform: scale(1.08); box-shadow: var(--shadow-md-current); }

        /* Results List */
        .result { list-style: none; padding: 0; flex-grow: 1; display: flex; flex-direction: column; margin-bottom: var(--space-5); gap: var(--space-3); }
        .result > li {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background-color: var(--result-item-bg);
            border: var(--border-width) solid var(--result-item-border);
            box-shadow: var(--shadow-sm-current);
            padding: var(--space-3) var(--space-4);
            transition: background-color var(--transition-base),
                        border-color var(--transition-base),
                        transform var(--transition-base),
                        box-shadow var(--transition-base),
                        max-height var(--details-animation-duration) var(--transition-timing),
                        opacity calc(var(--details-animation-duration) * 0.8) var(--transition-timing),
                        margin-top var(--details-animation-duration) var(--transition-timing),
                        padding-top var(--details-animation-duration) var(--transition-timing),
                        padding-bottom var(--details-animation-duration) var(--transition-timing),
                        visibility 0s linear var(--details-animation-duration),
                        border-width var(--details-animation-duration) var(--transition-timing);
             animation: detailRowSlideIn 0.4s var(--transition-timing) backwards;
             opacity: 0;
             margin-bottom: 0;
        }
        .result > li:nth-child(1) { animation-delay: 0.1s; opacity: 1;}
        .result > li.detail-row:nth-of-type(2) { animation-delay: 0.15s; }
        .result > li.detail-row:nth-of-type(3) { animation-delay: 0.20s; }
        .result > li.detail-row:nth-of-type(4) { animation-delay: 0.25s; }
        .result > li.detail-row:nth-of-type(5) { animation-delay: 0.30s; }
        .result > li.detail-row:nth-of-type(6) { animation-delay: 0.35s; }
        .result > li::after { content: none; }

        .result > li:hover {
             background-color: var(--result-item-hover-bg);
             transform: translateY(-3px);
             box-shadow: var(--shadow-md-current), var(--result-item-inset-shadow);
             border-color: color-mix(in srgb, var(--clr-primary-current) 30%, transparent);
             z-index: 5;
        }
        .result li.main-result-toggle > .result-row,
        .result li.expandable > .result-row {
            cursor: pointer;
        }

        .result-row { display: flex; justify-content: space-between; align-items: center; gap: var(--space-2); padding: 0; min-height: auto; position: relative; z-index: 1; }
        .label { font-weight: 500; color: var(--clr-text-muted-current); font-size: var(--font-size-sm); line-height: var(--line-height-tight); padding-inline-end: var(--space-2); flex-grow: 1; display: flex; align-items: center; gap: var(--space-2); text-align: start; }
        .value-container { display: flex; align-items: center; justify-content: flex-end; gap: var(--space-1); text-align: end; flex-shrink: 0; }
        .value { flex-grow: 1; font-weight: 700; font-size: var(--font-size-lg); font-feature-settings: "tnum"; letter-spacing: 0.5px; transition: color var(--transition-base); line-height: var(--line-height-tight); text-align: end; white-space: nowrap; }
        .value.is-updating { animation: none; }
        .value.info { color: var(--clr-text-current); font-weight: 500; }
        .value.warning { color: var(--clr-warning-current); }
        .value.primary { color: var(--clr-primary-current); }
        .value.success { color: var(--clr-success-current); }

        .main-result-toggle .toggle-details-button { font-size: var(--font-size-xs); font-weight: 500; color: var(--toggle-details-text-color); padding: var(--space-1) var(--space-2); margin-inline-start: var(--space-2); border-radius: var(--radius-sm); background-color: transparent; transition: background-color var(--transition-base), color var(--transition-base); border: 1px solid transparent; white-space: nowrap; flex-shrink: 0; }
        .main-result-toggle .toggle-details-button:hover { background-color: var(--toggle-details-hover-bg); }
        .main-result-toggle .toggle-details-button:focus-visible { outline: none; border-color: var(--clr-primary-current); box-shadow: 0 0 0 var(--focus-ring-width) var(--clr-primary-focus-ring-current); }

        .details-icon { display: inline-flex; align-items: center; justify-content: center; width: 1.5em; height: 1.5em; color: var(--clr-text-muted-current); transition: transform var(--transition-base), color var(--transition-base), background-color var(--transition-base); flex-shrink: 0; margin-inline-start: var(--space-1); border-radius: 50%; position: relative; }
        .details-icon svg { width: 0.7em; height: 0.7em; stroke-width: 2.5; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: opacity 0.2s ease-in-out; }
        .details-icon .icon-plus { opacity: 1; }
        .details-icon .icon-minus { opacity: 0; }
        .result li.detail-row.expanded .details-icon .icon-plus { opacity: 0; }
        .result li.detail-row.expanded .details-icon .icon-minus { opacity: 1; color: var(--clr-primary-current); }
        .result li.expandable > .result-row:hover .details-icon { background-color: color-mix(in srgb, var(--clr-primary-current) 8%, transparent); }

        /* Hidden/shown detail rows */
        .detail-row {
            max-height: 0;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            overflow: hidden;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border-width: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            box-shadow: none !important;
            transition: max-height var(--details-animation-duration) var(--transition-timing),
                        opacity calc(var(--details-animation-duration) * 0.8) var(--transition-timing),
                        transform var(--details-animation-duration) var(--transition-timing),
                        margin-top var(--details-animation-duration) var(--transition-timing),
                        padding-top var(--details-animation-duration) var(--transition-timing),
                        padding-bottom var(--details-animation-duration) var(--transition-timing),
                        visibility 0s linear var(--details-animation-duration),
                        border-width var(--details-animation-duration) var(--transition-timing),
                        box-shadow var(--transition-base);
            animation: none;
        }

        .main-result-toggle.details-expanded ~ .detail-row {
            max-height: 600px;
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
            border-width: var(--border-width) !important;
            padding-top: var(--space-3) !important;
            padding-bottom: var(--space-3) !important;
            margin-top: var(--space-3);
            box-shadow: var(--shadow-sm-current) !important;
            animation: detailRowSlideIn 0.4s var(--transition-timing) backwards;
        }
         /* Re-apply stagger delays */
         .main-result-toggle.details-expanded ~ .detail-row:nth-of-type(2) { animation-delay: 0.05s; }
         .main-result-toggle.details-expanded ~ .detail-row:nth-of-type(3) { animation-delay: 0.10s; }
         .main-result-toggle.details-expanded ~ .detail-row:nth-of-type(4) { animation-delay: 0.15s; }
         .main-result-toggle.details-expanded ~ .detail-row:nth-of-type(5) { animation-delay: 0.20s; }
         .main-result-toggle.details-expanded ~ .detail-row:nth-of-type(6) { animation-delay: 0.25s; }


         .detail-row .result-row {
             padding: var(--space-2) 0;
             min-height: auto;
             padding-inline-start: var(--space-2);
         }
         [dir="rtl"] .detail-row .result-row {
             padding-inline-start: 0;
             padding-inline-end: var(--space-2);
          }
         .detail-row .label { font-size: calc(var(--font-size-sm) * 0.95); }
         .detail-row .value { font-size: calc(var(--font-size-lg) * 0.95); }

        /* Calculation Details */
        .detail-row.expandable > .result-row { cursor: pointer; }
        .calculation-details {
            background-color: var(--details-bg);
            border-radius: var(--radius-md);
            padding: 0 var(--space-3);
            margin: var(--space-2) var(--space-1) var(--space-1);
            font-size: var(--font-size-xs);
            color: var(--detail-calc-text-color);
            line-height: var(--line-height-base);
            overflow: hidden; max-height: 0; opacity: 0;
            transition: max-height var(--details-animation-duration) var(--transition-timing), opacity calc(var(--details-animation-duration)*0.8) var(--transition-timing), padding var(--details-animation-duration) var(--transition-timing), margin-top var(--details-animation-duration) var(--transition-timing);
             margin-top: 0;
        }
        [data-theme="light"] .calculation-details { color: var(--clr-gray-700); }
        .detail-row.expanded .calculation-details { max-height: 150px; opacity: 1; padding: var(--space-2) var(--space-3); margin-top: var(--space-2); }
        .calculation-details code {
            font-family: monospace;
            background: var(--detail-calc-code-bg);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-weight: 500;
            color: var(--clr-text-current);
            border: 1px solid var(--separator-color);
        }

        /* Fee Visualization Bar */
        .fee-visualization { margin-top: auto; padding: var(--space-4) var(--space-2) var(--space-2); border-top: var(--border-width) solid var(--clr-border-current); }
        .viz-bar-label { font-size: var(--font-size-xs); color: var(--clr-text-muted-current); margin-bottom: var(--space-2); text-align: center; }
        .viz-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background-color: color-mix(in srgb, var(--clr-border-current) 50%, transparent); }
        .viz-bar-segment { height: 100%; transition: flex-basis 0.5s var(--transition-timing); }
        .viz-bar-profit { background-color: var(--viz-bar-profit-bg); }
        .viz-bar-fees { background-color: var(--viz-bar-fee-bg); }


        /* ==========================================================================
           8. Responsive Overrides
           ========================================================================== */

        /* Desktop - Balanced Height & Polish */
        @media (min-width: 992px) {
             html { font-size: 100%; }

             .main-container {
                 flex-direction: row;
                 gap: var(--space-6);
                 align-items: flex-start;
                 margin-top: var(--space-4);
                 padding: 0 var(--space-6);
                 margin-bottom: var(--space-4);
                 flex-grow: 1;
                 width: 100%;
                 max-width: 1600px;
             }

             .sidebar {
                 flex: 0 0 480px;
                 position: sticky; top: var(--space-4);
                 align-self: flex-start;
                 overflow-y: auto; 
                 background: var(--sidebar-desktop-bg); border-inline-end: var(--border-width) solid var(--clr-border-current); border-top: none; border-bottom: none; border-inline-start: none; box-shadow: var(--shadow-md-current); display: flex; flex-direction: column;
                 border-radius: var(--radius-lg);
                 padding: var(--space-5); 
             }
             .sidebar-header {
                 padding-bottom: var(--space-3);
                 margin-bottom: var(--space-3);
                 .controls { gap: var(--space-3); margin-top: var(--space-3); }
                 .control-btn { height: 3rem; padding: var(--space-2) var(--space-3); font-size: var(--font-size-sm); } 
             }
             .sidebar-content-wrapper {
                 padding: var(--space-3) 0;
                 gap: var(--space-3);
             }
              .sidebar-logo-container {
                  margin: 0 auto var(--space-3);
                  max-width: 180px;
             }
              .sidebar-title { font-size: var(--font-size-md); margin-bottom: var(--space-2); }
             label[for="price"] {
                 margin-bottom: var(--space-2); 
                 font-size: var(--font-size-sm); 
             }
             .input-wrapper { max-width: 100%; border-radius: var(--radius-md); }
             .input-wrapper input#price {
                 padding-block: var(--space-2); 
                 font-size: var(--font-size-lg);
             }
             #btnClear { width: 3rem; } 
             
             .note-faq-main-container { /* Main FAQ container on desktop */
                 margin-top: var(--space-4);
                 padding: var(--space-3) var(--space-4);
             }
              .note-faq-main-container > summary { /* Main summary on desktop */
                font-size: var(--font-size-lg);
                padding: var(--space-3);
              }
             .note-faq-content-wrapper details summary { /* Individual item summary */
                 font-size: var(--font-size-base);
                 padding: var(--space-3);
             }
             .note-faq-content { /* Individual item content */
                 font-size: var(--font-size-sm);
                 padding: var(--space-1) var(--space-4) var(--space-3) var(--space-4);
             }


             .fee-options-container {
                padding: var(--space-3);
             }
             .provider-selection fieldset {
                justify-content: space-around;
                flex-wrap: nowrap;
             }
             .provider-selection legend, .settlement-toggle-wrapper .toggle-label {
                font-size: var(--font-size-sm);
             }
             .provider-selection label {
                font-size: var(--font-size-sm);
             }


             /* Card Adjustments - Kept relatively tight to control overall page height */
             .card {
                padding: var(--space-4);
                border-radius: var(--radius-lg);
             }
             .card-header {
                margin-bottom: var(--space-3);
                padding-bottom: var(--space-2);
                gap: var(--space-1);
             }
             .logos-container img { height: 28px; }

             /* Result List Adjustments - Kept relatively tight */
             .result {
                 gap: var(--space-2);
                 margin-bottom: var(--space-3);
             }
             .result > li { margin-bottom: 0; }
             .result li {
                 padding: var(--space-2) var(--space-3);
                 border-radius: var(--radius-md);
             }
             .result li.main-result-toggle {
                 padding: var(--space-3) var(--space-3);
             }
             .main-result-toggle.details-expanded ~ .detail-row { margin-top: var(--space-2); }
             .detail-row .result-row {
                 padding: var(--space-1) 0;
                 padding-inline-start: var(--space-3);
             }
             [dir="rtl"] .detail-row .result-row {
                 padding-inline-start: 0;
                 padding-inline-end: var(--space-3);
             }
             .calculation-details {
                font-size: calc(var(--font-size-xs) * 0.9);
                padding: var(--space-1) var(--space-2);
                margin: var(--space-1) 0 0 0;
                border-radius: var(--radius-sm);
             }
              .detail-row.expanded .calculation-details {
                  padding: var(--space-1) var(--space-2);
                  margin-top: var(--space-1);
              }

             /* Font sizes */
             .value { font-size: 1.5rem; }
             .detail-row .value { font-size: 1.15rem; }
             .label { font-size: var(--font-size-sm); }
             .detail-row .label { font-size: var(--font-size-xs); }

             .page-footer {
                 padding: var(--space-4);
                 font-size: var(--font-size-sm); 
                 margin-top: auto;
                 flex-shrink: 0;
              }
             /* Fee Visualization */
             .fee-visualization {
                 display: block;
                 padding: var(--space-3) var(--space-1) var(--space-1);
                 margin-top: var(--space-3);
             }
             .control-btn .btn-text { display: inline !important; }
        }

        /* Tablet Styles */
        @media (min-width: 601px) and (max-width: 991px) {
             html { font-size: 100%; }
             .main-container { flex-direction: column; padding: 0 var(--space-6); gap: var(--space-6); margin-bottom: var(--space-9); margin-top: var(--space-7); flex-grow: 1; }
             .sidebar { padding: var(--space-5); border-radius: var(--radius-xl); }
             .result { gap: var(--space-3); margin-bottom: var(--space-4); }
             .result > li { margin-bottom: 0; }
             .result li { padding: var(--space-3) var(--space-4); border-radius: var(--radius-lg);}
             .main-result-toggle.details-expanded ~ .detail-row { margin-top: var(--space-3); }
             .detail-row .result-row { padding: var(--space-1) 0; padding-inline-start: var(--space-4); }
             [dir="rtl"] .detail-row .result-row { padding-inline-start: 0; padding-inline-end: var(--space-4); }
             .value { font-size: var(--font-size-xl); }
             .detail-row .value { font-size: var(--font-size-lg); }
            .control-btn .btn-icon-wrapper { display: inline-flex !important; }
            .control-btn .btn-text { display: inline !important; }
            .control-btn { height: 2.8rem; min-width: 3rem; }
            .fee-visualization { display: block; }
            .page-footer { padding: var(--space-6); font-size: var(--font-size-sm); margin-top: auto; }
             .fee-options-container {
                margin-top: var(--space-5);
             }
             .note-faq-main-container {
                 padding: var(--space-2) var(--space-3);
             }
        }

        /* Mobile Styles */
        @media (max-width: 600px) {
             html { font-size: 100%; }
             .main-container { margin: var(--space-4) auto; padding: 0 var(--space-2); gap: var(--space-4); margin-bottom: var(--space-6); flex-grow: 1; }
             .sidebar { padding: var(--space-2) var(--space-3); }
             .sidebar-header { padding-bottom: var(--space-2); margin-bottom: var(--space-2); }
             .sidebar-logo-container { margin-bottom: var(--space-1); max-width: 140px; }
             .controls { gap: var(--space-1); margin-top: var(--space-2); }
             .sidebar-content-wrapper { margin-top: var(--space-2); gap: var(--space-1); }
             label[for="price"] { margin-bottom: var(--space-1); font-size: calc(var(--font-size-sm) * 0.9); }
             .input-wrapper input#price { padding-block: var(--space-1); font-size: var(--font-size-md); }
             #btnClear { width: 2.4rem; height: 2.4rem; }
             #btnClear svg { width: 1em; height: 1em; }
            
             .note-faq-main-container {
                 margin-top: var(--space-3);
                 padding: var(--space-1);
             }
             .note-faq-main-container > summary {
                font-size: var(--font-size-md);
                padding: var(--space-2);
             }
             .note-faq-content-wrapper details summary {
                 padding: var(--space-2);
                 font-size: calc(var(--font-size-sm) * 0.92);
             }
             .note-faq-content {
                 padding: 0 var(--space-2) var(--space-2) var(--space-2);
                 font-size: calc(var(--font-size-xs) * 0.92);
             }


             .result {
                 gap: var(--space-1);
                 margin-bottom: var(--space-2);
             }
             .result > li { margin-bottom: 0; }
             .result li { padding: var(--space-1) var(--space-2); border-radius: var(--radius-md); }
              .main-result-toggle.details-expanded ~ .detail-row {
                   padding-top: 0 !important;
                   padding-bottom: 0 !important;
                   margin-top: var(--space-1);
              }
             .result-row { flex-wrap: wrap; gap: 0; padding: 0; min-height: unset;}
             .label { flex-basis: 100%; padding-bottom: var(--space-1);}
             .value-container { flex-basis: 100%; justify-content: flex-start; margin-top: 0; }
             .value { font-size: var(--font-size-md); text-align: start !important; white-space: normal; }
             .detail-row .result-row { padding: var(--space-1) 0; padding-inline-start: var(--space-1); flex-wrap: wrap; }
             [dir="rtl"] .detail-row .result-row { padding-inline-start: 0; padding-inline-end: var(--space-1); }
             .detail-row .label { font-size: calc(var(--font-size-sm) * 0.88); }
             .detail-row .value { font-size: calc(var(--font-size-lg) * 0.88); }
             .control-btn .btn-icon-wrapper { display: inline-flex !important; width: 1.4em; height: 1.4em; }
             .control-btn { height: 2.4rem; width: 2.4rem; }
             .control-btn .btn-text { display: none !important; }
             #btn-lang .btn-icon-wrapper { display: none !important; }
             #btn-lang .lang-text { display: inline !important; font-size: 1em; font-weight: 700; margin: 0; line-height: 1; color: var(--clr-primary-current); }
             #btn-lang { gap: 0; }
             .fee-visualization { display: none; }
             .calculation-details { padding: 0 var(--space-2); margin: var(--space-1) 0 var(--space-1) 0; }
            .detail-row.expanded .calculation-details { padding: var(--space-1) var(--space-2); margin-top: var(--space-1); }
            .page-footer { padding: var(--space-4); font-size: var(--font-size-xs); margin-top: auto; }
            .fee-options-container { margin-top: var(--space-3); padding: var(--space-2); }
            .provider-selection fieldset {
                flex-direction: row;
                justify-content: space-around;
                align-items: stretch;
            }
            .provider-selection .provider-option {
                padding: var(--space-1);
                min-width: 0;
                flex-direction: row;
                align-items: center;
                gap: var(--space-1);
            }
             .provider-selection .provider-option label {
                font-size: calc(var(--font-size-sm) * 0.85);
            }
            .settlement-toggle-wrapper {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            .settlement-toggle-wrapper .toggle-label {
                 font-size: calc(var(--font-size-sm) * 0.9);
                 margin-bottom: 0;
                 text-align: start;
            }

        }

        /* Print Styles (Unchanged) */
        @media print { /* (Stable print styles) */ }

    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="main-container">
            <aside class="sidebar input-section">
                  <div class="sidebar-header">
                      <div class="sidebar-logo-container">
                         <img src="https://www2.0zz0.com/2025/04/29/23/183916568.png" alt="شعار الشروق لمواد البناء" id="storeLogo">
                     </div>
                     <div class="controls">
                          <button type="button" id="btn-lang" class="control-btn" title="..." aria-label="...">
                              <span class="btn-icon-wrapper">
                                  </span>
                              <span class="btn-text lang-text">...</span>
                          </button>
                          <button type="button" id="btn-theme" class="control-btn" title="..." aria-label="...">
                               <span class="btn-icon-wrapper theme-icon-wrapper"></span>
                               <span class="btn-text theme-text">...</span>
                           </button>
                          <button type="button" id="btnPrint" class="control-btn" title="..." aria-label="...">
                              <span class="btn-icon-wrapper">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                              </span>
                              <span class="btn-text print-text">طباعة</span> </button>
                          <button type="button" id="btnShareWhatsapp" class="control-btn" title="..." aria-label="...">
                              <span class="btn-icon-wrapper"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Logo" /> </span>
                              <span class="btn-text share-text">واتساب</span> </button>
                     </div>
                  </div>
                 <div class="sidebar-content-wrapper">
                     <h1 class="sidebar-title" id="title">آلة حاسبة لرسوم الدفع الآجل</h1>
                     <label for="price" data-key="inputLabel">أدخل سعر الفاتورة الإجمالي</label>
                     <div class="input-wrapper">
                         <input type="text" id="price" inputmode="decimal" placeholder="0.00 ر.س">
                         <button type="button" class="clear-input-btn" id="btnClear" aria-label="مسح" title="مسح للخلف / مسح كلي (ضغطة مطولة)" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75L14.25 12m0 0l2.25 2.25M14.25 12l2.25-2.25M14.25 12L12 14.25m-2.58 4.92l-6.375-6.375a1.125 1.125 0 010-1.59L9.42 4.83c.211-.211.498-.33.796-.33H19.5a2.25 2.25 0 012.25 2.25v10.5a2.25 2.25 0 01-2.25 2.25h-9.284c-.298 0-.585-.119-.796-.33z" /></svg>
                         </button>
                     </div>

                     <div class="fee-options-container">
                        <div class="provider-selection">
                            <legend data-key="providerChoiceLabel">اختر مقدم الخدمة لرسوم التسوية (للمبالغ الأقل من 2500 ريال):</legend>
                            <fieldset>
                                <div class="provider-option">
                                    <input type="radio" id="providerTabby" name="provider" value="tabby" checked>
                                    <label for="providerTabby" data-key="providerTabbyLabel">تابي</label>
                                </div>
                                <div class="provider-option">
                                    <input type="radio" id="providerTamara" name="provider" value="tamara">
                                    <label for="providerTamara" data-key="providerTamaraLabel">تمارا</label>
                                </div>
                            </fieldset>
                        </div>
                        <div class="settlement-toggle-wrapper">
                            <label for="includeSettlement" data-key="includeSettlementLabel" class="toggle-label">إضافة رسوم التسوية (للمبالغ الأقل من 2500 ريال):</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="includeSettlement">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                 </div>
                 <details class="note-faq-main-container" id="mainFaqToggle">
                    <summary id="mainFaqToggleSummary" data-key="notesTitle">ملاحظات هامة حول التسوية والرسوم:</summary>
                    <div class="note-faq-content-wrapper" id="noteFaqContainerInner">
                        {/* FAQ items will be injected here by JavaScript */}
                    </div>
                </details>
            </aside>

            <main class="main-content-area results-section">
                 <div class="cards">
                    <div class="card" id="providerCard">
                        <div class="card-header">
                            <h2 data-key="combinedTitle">تابي / تمارا</h2>
                            <div class="logos-container">
                                <img src="https://cdn.salla.sa/BmwbV/Ea1Kx4SfpK2Vy3Lx3aVPvZKBMkSM5dio2eKveTwm.png" alt="شعار تابي">
                                <img src="https://cdn.tamara.co/assets/png/tamara-logo-badge-en.png" alt="شعار تمارا">
                            </div>
                        </div>
                         <ul class="result">
                            <li class="main-result-toggle" data-result-key="totalAmountDue">
                                <div class="result-row">
                                    <span class="label" data-key="totalAmountDueLabel">المبلغ المطلوب من العميل</span>
                                    <div class="value-container">
                                        <span class="value primary charge" aria-live="polite" data-raw-value="0">0.00 ر.س</span>
                                        <button type="button" class="toggle-details-button" aria-label="تبديل عرض التفاصيل">
                                            <span class="toggle-text">...</span>
                                        </button>
                                    </div>
                                </div>
                            </li>
                            <li class="detail-row expandable" data-details-type="baseFee">
                                <div class="result-row">
                                    <span class="label" data-key="baseFeeLabel">رسوم الخدمة (6.99% + 1.5 ر.س)</span>
                                    <div class="value-container">
                                        <span class="value info base" aria-live="polite" data-raw-value="0">0.00 ر.س</span>
                                        <span class="details-icon" aria-hidden="true">
                                            <svg class="icon-plus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>
                                            <svg class="icon-minus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg>
                                        </span>
                                    </div>
                                </div> <div class="calculation-details"></div> </li>
                            <li class="detail-row expandable" data-details-type="vat">
                                <div class="result-row">
                                    <span class="label" data-key="vatLabel">ضريبة القيمة المضافة (15%)</span>
                                    <div class="value-container">
                                        <span class="value info vat" aria-live="polite" data-raw-value="0">0.00 ر.س</span>
                                        <span class="details-icon" aria-hidden="true">
                                            <svg class="icon-plus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>
                                            <svg class="icon-minus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg>
                                        </span>
                                    </div>
                                </div> <div class="calculation-details"></div> </li>
                            <li class="detail-row expandable" data-details-type="totalServiceFee">
                                <div class="result-row">
                                    <span class="label" data-key="totalServiceFeeLabel">إجمالي رسوم الخدمة</span>
                                     <div class="value-container">
                                        <span class="value warning serviceFee" aria-live="polite" data-raw-value="0">0.00 ر.س</span>
                                         <span class="details-icon" aria-hidden="true">
                                            <svg class="icon-plus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>
                                            <svg class="icon-minus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg>
                                        </span>
                                    </div>
                                </div>
                                 <div class="calculation-details"></div>
                            </li>
                            <li class="detail-row expandable" data-details-type="settlementFee" id="settlementFeeRow">
                                <div class="result-row">
                                    <span class="label" data-key="settlementFeeLabel">رسوم التسوية/التحويل</span>
                                    <div class="value-container">
                                        <span class="value warning settlementFee" aria-live="polite" data-raw-value="0">0.00 ر.س</span>
                                        <span class="details-icon" aria-hidden="true">
                                            <svg class="icon-plus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>
                                            <svg class="icon-minus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg>
                                        </span>
                                    </div>
                                </div> <div class="calculation-details"></div> </li>
                            <li class="detail-row expandable" data-details-type="netProfit">
                                <div class="result-row">
                                    <span class="label" data-key="netProfitLabel">صافي ربح المتجر</span>
                                     <div class="value-container">
                                        <span class="value success net" aria-live="polite" data-raw-value="0">0.00 ر.س</span>
                                         <span class="details-icon" aria-hidden="true">
                                            <svg class="icon-plus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>
                                            <svg class="icon-minus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg>
                                        </span>
                                    </div>
                                </div>
                                 <div class="calculation-details"></div>
                             </li>
                        </ul>
                         <div class="fee-visualization">
                              <div class="viz-bar-label" data-key="vizLabel" id="vizLabelId">تفصيل المبلغ المطلوب من العميل</div>
                              <div class="viz-bar" role="img" aria-labelledby="vizLabelId">
                                  <div class="viz-bar-segment viz-bar-profit" title="صافي الربح" style="flex-basis: 100%;"></div>
                                  <div class="viz-bar-segment viz-bar-fees" title="إجمالي الرسوم" style="flex-basis: 0%;"></div>
                              </div>
                        </div>
                    </div>
                 </div>
            </main>
        </div>

        <footer class="page-footer">
            <span id="footerContent">© <span id="year"></span> الشروق لمواد البناء. جميع الحقوق محفوظة.</span>
        </footer>
    </div>

     <script>
         // ==========================================================================
         //  Calculator Script - v5.2 (Fee Options Redesign, FAQ Wording, Footer)
         // ==========================================================================
         document.addEventListener('DOMContentLoaded', () => {
             // --- Elements ---
             const priceInput = document.getElementById('price');
             const btnLang = document.getElementById('btn-lang');
             const btnTheme = document.getElementById('btn-theme');
             const btnClear = document.getElementById('btnClear');
             const btnPrint = document.getElementById('btnPrint');
             const btnShareWhatsapp = document.getElementById('btnShareWhatsapp');
             const themeIconWrapper = btnTheme?.querySelector('.theme-icon-wrapper');
             const langIconWrapper = btnLang?.querySelector('.btn-icon-wrapper');
             const langTextEl = btnLang?.querySelector('.lang-text');
             const themeTextEl = btnTheme?.querySelector('.theme-text');
             const printTextEl = btnPrint?.querySelector('.print-text');
             const shareTextEl = btnShareWhatsapp?.querySelector('.share-text');
             const yearEl = document.getElementById('year');
             const footerContentEl = document.getElementById('footerContent');
             const mainFaqToggle = document.getElementById('mainFaqToggle'); // Main FAQ toggle
             const noteFaqContainerInner = document.getElementById('noteFaqContainerInner'); // Inner container for FAQ items
             const providerCard = document.getElementById('providerCard');
             const pageBody = document.body;
             const providerTabbyRadio = document.getElementById('providerTabby');
             const providerTamaraRadio = document.getElementById('providerTamara');
             const includeSettlementCheckbox = document.getElementById('includeSettlement');
             const settlementFeeRow = document.getElementById('settlementFeeRow');


             // --- Icons (Unchanged) ---
             const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-label="وضع ليلي"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>`;
             const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-label="وضع نهاري"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>`;
             const languageIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m5 8 6 6"/>
                  <path d="m4 14 6-6 2-3"/>
                  <path d="M2 5h12"/>
                  <path d="M7 2h1"/>
                  <path d="m22 22-5-10-5 10"/>
                  <path d="M14 18h6"/>
                </svg>`;

            // --- Constants ---
            const SERVICE_RATE = 0.0699;
            const FIXED_FEE = 1.5;
            const VAT_RATE = 0.15;
            const SETTLEMENT_TABBY = 28.75;
            const SETTLEMENT_TAMARA = 25.00;
            const TRANSFER_FEE_BASE = 6.00;
            const TRANSFER_FEE_TOTAL = parseFloat((TRANSFER_FEE_BASE * (1 + VAT_RATE)).toFixed(2));
            const SETTLEMENT_THRESHOLD = 2500;


             // i18n object
             const i18n = {
                 ar: {
                    pageTitle: "الشروق لمواد البناء - حاسبة رسوم المتجر",
                    mainTitle: "آلة حاسبة لرسوم الدفع الآجل",
                    inputLabel: " أدخل مبلغ الفاتورة المطلوب",
                    pricePlaceholder: "0.00 ر.س",
                    notesTitle: "ملاحظات هامة حول التسوية والرسوم:", // Main title for the collapsible FAQ
                    noteItems: [
                        {
                            question: `رسوم التسوية (للمبالغ الأقل من ${SETTLEMENT_THRESHOLD} ريال)`,
                            answer: `<ul>
                                        <li>تابي: <strong>${SETTLEMENT_TABBY.toFixed(2)} ر.س</strong></li>
                                        <li>تمارا: <strong>${SETTLEMENT_TAMARA.toFixed(2)} ر.س</strong></li>
                                        <li>هذه الرسوم تُخصم <strong>مرة واحدة</strong> على إجمالي مبلغ التسوية لكل دورة. يمكنك تفعيل خيار "إضافة رسوم التسوية" إذا كانت هذه أول عملية في دورة التسوية الحالية، أو إذا كنت ترغب في تضمينها في حساب المبلغ المطلوب من العميل.</li>
                                    </ul>`
                        },
                        {
                            question: `رسوم التسوية (للمبالغ ${SETTLEMENT_THRESHOLD} ريال فأكثر)`,
                            answer: `<ul>
                                        <li>يتم تطبيق رسوم تحويل بنكي ثابتة قدرها <strong>${TRANSFER_FEE_BASE.toFixed(2)} ر.س</strong> بالإضافة إلى ضريبة القيمة المضافة (15%)، ليصبح الإجمالي <strong>${TRANSFER_FEE_TOTAL.toFixed(2)} ر.س</strong>. هذه الرسوم إلزامية لهذه الفئة من المبالغ.</li>
                                    </ul>`
                        },
                        {
                            question: "مواعيد معالجة التسويات الأسبوعية:",
                            answer: `<ul>
                                        <li><strong>تمارا:</strong> تتم معالجة التسويات الأسبوعية صباح كل يوم <strong>سبت</strong>.</li>
                                        <li><strong>تابي:</strong> تتم معالجة التسويات الأسبوعية صباح كل يوم <strong>ثلاثاء</strong>.</li>
                                    </ul>`
                        }
                    ],
                    themeToggle: "تغيير السمة", langToggle: "تغيير اللغة",
                    themeNight: "ليلي", themeDay: "نهاري",
                    langSwitchTo: "English", langCurrentShort: "ع", otherLangShort: "EN", otherLangLong: "English",
                    printButtonLabel: "طباعة", shareButtonLabel: "واتساب",
                    shareMessageTemplate: `حاسبة الشروق:\n- صافي ربح المتجر: {P} {C}\n- المبلغ المطلوب من العميل (مع الرسوم): {X} {C}`,
                    footerText: `© {YEAR} الشروق لمواد البناء. جميع الحقوق محفوظة.`,
                    currencySuffix: " ر.س",
                    combinedTitle: "تابي / تمارا",
                    clearButtonLabel: "مسح", clearButtonTitle: "مسح للخلف / مسح كلي (ضغطة مطولة)",
                    showDetailsText: "عرض التفاصيل", hideDetailsText: "إخفاء التفاصيل",
                    providerChoiceLabel: `اختر مقدم الخدمة لرسوم التسوية (للمبالغ الأقل من ${SETTLEMENT_THRESHOLD} ريال):`,
                    providerTabbyLabel: `تابي (${SETTLEMENT_TABBY.toFixed(2)} ر.س)`,
                    providerTamaraLabel: `تمارا (${SETTLEMENT_TAMARA.toFixed(2)} ر.س)`,
                    includeSettlementLabel: `إضافة رسوم التسوية (للمبالغ الأقل من ${SETTLEMENT_THRESHOLD} ريال):`,
                    settlementFeeLabel_provider: "رسوم التسوية (اختياري)",
                    settlementFeeLabel_transfer: `رسوم التحويل البنكي (${TRANSFER_FEE_TOTAL.toFixed(2)} ر.س)`,
                    labels: [
                        `رسوم الخدمة (${(SERVICE_RATE * 100).toFixed(2)}% + ${FIXED_FEE.toFixed(1)} ر.س)`,
                        'ضريبة القيمة المضافة (15%)',
                        'إجمالي رسوم الخدمة',
                        'رسوم التسوية/التحويل',
                        'المبلغ المطلوب من العميل',
                        'صافي ربح المتجر'
                    ],
                    labelKeys: [ 'baseFeeLabel', 'vatLabel', 'totalServiceFeeLabel', 'settlementFeeLabel', 'totalAmountDueLabel', 'netProfitLabel' ],
                    calculationDetails: {
                        baseFee: (x, fee, suffix) => `المعادلة: (المبلغ المطلوب <code>${x}</code> × ${(SERVICE_RATE * 100).toFixed(2)}%) + ${FIXED_FEE.toFixed(2)} = <code>${fee}</code> ${suffix}`,
                        vat: (base, vatFee, suffix) => `المعادلة: (رسوم الخدمة <code>${base}</code> × 15%) = <code>${vatFee}</code> ${suffix}`,
                        settlementFee: (type, providerName, fee, suffix, isActive, x_val) => {
                            if (type === 'bank_transfer') {
                                return `رسوم تحويل بنكي (لأن المبلغ ${formatNumber(x_val)} ريال أو أكثر): <code>${fee}</code> ${suffix} (شاملة ضريبة القيمة المضافة).`;
                            } else if (type === 'provider_settlement') {
                                return isActive ? `رسوم تسوية ${providerName} (لأن المبلغ أقل من ${SETTLEMENT_THRESHOLD} ريال): <code>${fee}</code> ${suffix}` : `رسوم تسوية ${providerName} غير مضافة (المبلغ أقل من ${SETTLEMENT_THRESHOLD} ريال).`;
                            }
                            return 'لا توجد رسوم تسوية/تحويل مطبقة.';
                        },
                        totalServiceFee: (base, vat, total, suffix) => `المجموع: رسوم الخدمة (<code>${base}</code>) + الضريبة (<code>${vat}</code>) = <code>${total}</code> ${suffix}`,
                        netProfit: (p, suffix) => `يمثل صافي الربح المطلوب للمتجر: <code>${p}</code> ${suffix}`
                    },
                    vizLabel: "تفصيل المبلغ المطلوب من العميل", vizProfitTitle: "صافي الربح", vizFeeTitle: "إجمالي الرسوم"
                },
                 en: {
                    pageTitle: "Al-Shorouq Building Materials - Merchant Fee Calculator",
                    mainTitle: "Deferred Payment Fee Calculator",
                    inputLabel: "Enter Total Invoice Price",
                    pricePlaceholder: "0.00 SAR",
                    notesTitle: "Important Notes on Settlement & Fees:", // Main title for the collapsible FAQ
                    noteItems: [
                        {
                            question: `Settlement Fees (for amounts less than ${SETTLEMENT_THRESHOLD} SAR)`,
                            answer: `<ul>
                                        <li>Tabby: <strong>${SETTLEMENT_TABBY.toFixed(2)} SAR</strong></li>
                                        <li>Tamara: <strong>${SETTLEMENT_TAMARA.toFixed(2)} SAR</strong></li>
                                        <li>These fees are charged <strong>once</strong> per total settlement amount for each cycle. You can enable the "Include Settlement Fee" option if this is the first transaction in the current settlement cycle, or if you wish to include it in the customer's payable amount.</li>
                                    </ul>`
                        },
                        {
                            question: `Settlement Fees (for amounts ${SETTLEMENT_THRESHOLD} SAR and above)`,
                            answer: `<ul>
                                        <li>A fixed bank transfer fee of <strong>${TRANSFER_FEE_BASE.toFixed(2)} SAR</strong> + VAT (15%) applies, totaling <strong>${TRANSFER_FEE_TOTAL.toFixed(2)} SAR</strong>. This fee is mandatory for this amount range.</li>
                                    </ul>`
                        },
                        {
                            question: "When are weekly settlements processed by providers?",
                            answer: `<ul>
                                        <li><strong>Tamara:</strong> Weekly settlements are processed every <strong>Saturday</strong>.</li>
                                        <li><strong>Tabby:</strong> Weekly settlements are processed every <strong>Tuesday</strong>.</li>
                                    </ul>`
                        }
                    ],
                    themeToggle: "Change Theme", langToggle: "Change Language",
                    themeNight: "Night", themeDay: "Day",
                    langSwitchTo: "عربي", langCurrentShort: "EN", otherLangShort: "ع", otherLangLong: "عربي",
                    printButtonLabel: "Print", shareButtonLabel: "WhatsApp",
                    shareMessageTemplate: `Al-Shorouq Calculator:\n- Store Net Profit: {P} {C}\n- Customer Pays (w/ Fees): {X} {C}`,
                    footerText: `© {YEAR} Al-Shorouq Building Materials. All rights reserved.`,
                    currencySuffix: " SAR",
                    combinedTitle: "Tabby / Tamara",
                    clearButtonLabel: "Clear", clearButtonTitle: "Backspace / Clear All (Long Press)",
                    showDetailsText: "Show Details", hideDetailsText: "Hide Details",
                    providerChoiceLabel: `Choose provider for settlement fee (for amounts less than ${SETTLEMENT_THRESHOLD} SAR):`,
                    providerTabbyLabel: `Tabby (${SETTLEMENT_TABBY.toFixed(2)} SAR)`,
                    providerTamaraLabel: `Tamara (${SETTLEMENT_TAMARA.toFixed(2)} SAR)`,
                    includeSettlementLabel: `Include settlement fee (for amounts less than ${SETTLEMENT_THRESHOLD} SAR):`,
                    settlementFeeLabel_provider: "Settlement Fee (Optional)",
                    settlementFeeLabel_transfer: `Bank Transfer Fee (${TRANSFER_FEE_TOTAL.toFixed(2)} SAR)`,
                    labels: [
                        `Service Fee (${(SERVICE_RATE * 100).toFixed(2)}% + ${FIXED_FEE.toFixed(1)} SAR)`,
                        'VAT (15%)',
                        'Total Service Fees',
                        'Settlement/Transfer Fee',
                        'Amount Customer Pays',
                        'Net Merchant Profit'
                    ],
                    labelKeys: [ 'baseFeeLabel', 'vatLabel', 'totalServiceFeeLabel', 'settlementFeeLabel', 'totalAmountDueLabel', 'netProfitLabel' ],
                    calculationDetails: {
                        baseFee: (x, fee, suffix) => `Formula: (Amount Due <code>${x}</code> × ${(SERVICE_RATE * 100).toFixed(2)}%) + ${FIXED_FEE.toFixed(2)} = <code>${fee}</code> ${suffix}`,
                        vat: (base, vatFee, suffix) => `Formula: (Service Fee <code>${base}</code> × 15%) = <code>${vatFee}</code> ${suffix}`,
                        settlementFee: (type, providerName, fee, suffix, isActive, x_val) => {
                            if (type === 'bank_transfer') {
                                return `Bank transfer fee (because amount ${formatNumber(x_val)} SAR or more): <code>${fee}</code> ${suffix} (VAT inclusive).`;
                            } else if (type === 'provider_settlement') {
                                return isActive ? `${providerName} settlement fee (because amount is less than ${SETTLEMENT_THRESHOLD} SAR): <code>${fee}</code> ${suffix}` : `${providerName} settlement fee not included (amount is less than ${SETTLEMENT_THRESHOLD} SAR).`;
                            }
                             return 'No settlement/transfer fee applied.';
                        },
                        totalServiceFee: (base, vat, total, suffix) => `Sum: Service Fee (<code>${base}</code>) + VAT (<code>${vat}</code>) = <code>${total}</code> ${suffix}`,
                        netProfit: (p, suffix) => `Represents the desired net profit for the store: <code>${p}</code> ${suffix}`
                    },
                    vizLabel: "Customer Payment Breakdown", vizProfitTitle: "Net Profit", vizFeeTitle: "Total Fees"
                }
             };

             // --- State ---
             let currentTheme = localStorage.getItem('calculatorThemeFluentV2') || 'light';
             let currentLang = localStorage.getItem('calculatorLangFluentV2') || 'ar';
             let currentCalculations = { P_input: 0, X: 0, baseFee: 0, vat: 0, totalServiceFee: 0, S_final: 0, settlementType: null, providerForSettlement: null, settlementFeeActive: false };
             const mobileMediaQuery = window.matchMedia("(max-width: 600px)");

             // --- Utility Functions (Unchanged) ---
             const formatNumber = (n) => { const num = Number(n); if (isNaN(num)) { return '0.00'; } const sciThreshold = 1e12; return Math.abs(num) >= sciThreshold ? num.toExponential(2) : num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
             const updateElementText = (selector, text, parent = document) => { const el = parent?.querySelector(selector); if (el) el.textContent = text ?? ''; };
             const updateElementHTML = (selector, html, parent = document) => { const el = parent?.querySelector(selector); if (el) el.innerHTML = html ?? ''; };
             const updateAttribute = (selector, attr, value, parent = document) => { const el = parent?.querySelector(selector); if (el) el.setAttribute(attr, value ?? ''); };
             function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

             // --- Core Functions (Unchanged) ---
             function applyTheme() { pageBody?.setAttribute('data-theme', currentTheme); updateThemeButtonVisuals(); }
             function toggleTheme() { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem('calculatorThemeFluentV2', currentTheme); applyTheme(); }
             function switchLang() { currentLang = (currentLang === 'ar') ? 'en' : 'ar'; localStorage.setItem('calculatorLangFluentV2', currentLang); applyLang(); calculateFees(); }


            // --- Build FAQ Notes ---
            function buildFaqNotes(langData) {
                if (!noteFaqContainerInner || !langData || !langData.noteItems) return;
                noteFaqContainerInner.innerHTML = ''; // Clear existing inner FAQ items

                // Update the main FAQ toggle summary text
                const mainFaqSummary = document.getElementById('mainFaqToggleSummary');
                if (mainFaqSummary) {
                    mainFaqSummary.firstChild.nodeValue = langData.notesTitle || (currentLang === 'ar' ? 'ملاحظات هامة:' : 'Important Notes:');
                }


                langData.noteItems.forEach(item => {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.textContent = item.question;
                    const content = document.createElement('div');
                    content.classList.add('note-faq-content');
                    content.innerHTML = item.answer;

                    details.appendChild(summary);
                    details.appendChild(content);
                    noteFaqContainerInner.appendChild(details);
                });
            }

             // --- Apply Language ---
             function applyLang() {
                 const langData = i18n[currentLang];
                 if (!langData || !document.documentElement) return;
                 try {
                     document.documentElement.lang = currentLang;
                     document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                     updateElementText('#pageTitle', langData.pageTitle);
                     updateElementText('#title', langData.mainTitle);
                     updateElementText('label[for="price"]', langData.inputLabel);
                     updateAttribute('#price', 'placeholder', langData.pricePlaceholder);

                     buildFaqNotes(langData);

                     const currentYearVal = new Date().getFullYear();
                     if (footerContentEl && langData.footerText) {
                         footerContentEl.innerHTML = langData.footerText.replace('{YEAR}', currentYearVal);
                     } else if (yearEl) {
                        yearEl.textContent = currentYearVal;
                     }


                     updateAttribute('#btn-lang', 'title', langData.langToggle);
                     updateAttribute('#btn-lang', 'aria-label', langData.langToggle);
                     updateAttribute('#btn-theme', 'title', langData.themeToggle);
                     updateAttribute('#btn-theme', 'aria-label', langData.themeToggle);
                     updateAttribute('#btnClear', 'aria-label', langData.clearButtonLabel);
                     updateAttribute('#btnClear', 'title', langData.clearButtonTitle);
                     updateAttribute('#btnPrint', 'aria-label', langData.printButtonLabel);
                     updateAttribute('#btnPrint', 'title', langData.printButtonLabel);
                     updateAttribute('#btnShareWhatsapp', 'aria-label', langData.shareButtonLabel);
                     updateAttribute('#btnShareWhatsapp', 'title', langData.shareButtonLabel);

                     updateElementText('.provider-selection legend[data-key="providerChoiceLabel"]', langData.providerChoiceLabel);
                     updateElementText('label[for="providerTabby"]', langData.providerTabbyLabel);
                     updateElementText('label[for="providerTamara"]', langData.providerTamaraLabel);
                     updateElementText('.settlement-toggle-wrapper > label[for="includeSettlement"]', langData.includeSettlementLabel);


                     updateLabelsAndInteractiveElements(langData);
                     updateThemeButtonVisuals(langData);
                     updateLangButtonVisuals(langData);
                     providerCard?.querySelectorAll('li.detail-row.expanded').forEach(updateCalculationDetails);
                     updateToggleDetailsButtonText();
                     const suffix = langData.currencySuffix || 'SAR';
                     providerCard?.querySelectorAll('.value').forEach(el => {
                         let currentNum = 0;
                         if(el.dataset.rawValue) { currentNum = parseFloat(el.dataset.rawValue); }
                         else { currentNum = parseFloat(el.textContent.replace(/[^0-9.-]/g, '')) || 0;}
                         el.textContent = `${formatNumber(currentNum)}${suffix}`;
                         if (!el.dataset.rawValue) { el.dataset.rawValue = currentNum; }
                     });
                 } catch (error) { console.error("Error applying language:", error); }
            }
             // --- Update UI Labels/Text ---
             function updateLabelsAndInteractiveElements(langData) {
                 if (!langData || !providerCard) return;
                 const { labels, labelKeys, combinedTitle, vizLabel, vizProfitTitle, vizFeeTitle, printButtonLabel, shareButtonLabel, settlementFeeLabel_provider, settlementFeeLabel_transfer } = langData;
                 updateElementText('.card-header h2[data-key="combinedTitle"]', combinedTitle, providerCard);

                 labelKeys?.forEach((key, index) => {
                     if (labels?.[index]) {
                         const el = providerCard.querySelector(`.label[data-key="${key}"]`);
                         if (el) {
                             let labelText = labels[index];
                             if (key === 'settlementFeeLabel') {
                                 if (currentCalculations.settlementType === 'bank_transfer') {
                                     labelText = settlementFeeLabel_transfer;
                                 } else {
                                     labelText = settlementFeeLabel_provider;
                                 }
                             }
                             const textNode = Array.from(el.childNodes).find(n => n.nodeType === Node.TEXT_NODE && n.nodeValue.trim() !== '');
                             if (textNode) textNode.nodeValue = labelText + ' ';
                             else el.textContent = labelText + ' ';
                         }
                     }
                 });
                 updateElementText('.viz-bar-label', vizLabel, providerCard);
                 updateElementText('#vizLabelId', vizLabel);
                 updateAttribute('.viz-bar-profit', 'title', vizProfitTitle, providerCard);
                 updateAttribute('.viz-bar-fees', 'title', vizFeeTitle, providerCard);
                 updateElementText('#btnPrint .print-text', printButtonLabel);
                 updateElementText('#btnShareWhatsapp .share-text', shareButtonLabel);
            }
             // Update Theme Button Visuals (Unchanged)
             function updateThemeButtonVisuals(langData = i18n[currentLang]) { if (themeIconWrapper && themeTextEl && langData) { themeIconWrapper.innerHTML = currentTheme === 'light' ? sunIcon : moonIcon; themeTextEl.textContent = currentTheme === 'light' ? langData.themeNight : langData.themeDay; } }

             // Update Lang Button Visuals (Unchanged)
             function updateLangButtonVisuals(langData = i18n[currentLang]) {
                 if (btnLang && langIconWrapper && langTextEl && langData) {
                     if (langIconWrapper.innerHTML !== languageIconSvg) {
                         langIconWrapper.innerHTML = languageIconSvg;
                     }
                     const isMobile = mobileMediaQuery.matches;
                     if (isMobile) {
                         langTextEl.textContent = langData.otherLangShort;
                     } else {
                         langTextEl.textContent = langData.otherLangLong;
                     }
                 }
             }

             // --- Update Main Toggle Button Text (Unchanged) ---
             function updateToggleDetailsButtonText() { const mainToggle=providerCard?.querySelector('.main-result-toggle'); const buttonText=mainToggle?.querySelector('.toggle-details-button .toggle-text'); const langData=i18n[currentLang]; if(buttonText&&mainToggle&&langData){ const text=mainToggle.classList.contains('details-expanded')?langData.hideDetailsText:langData.showDetailsText; buttonText.textContent=text; buttonText.closest('button')?.setAttribute('aria-label', text); } }

            // --- Calculation Logic (MODIFIED for new settlement rules) ---
            function performCalculations(P_input_val) {
                const P_input = Math.max(0, Number(P_input_val) || 0);
                let X_calc = 0, baseFee_calc = 0, vat_calc = 0, totalServiceFee_calc = 0;
                let actualSettlementOrTransferFee = 0;
                let currentSettlementType = null;
                let providerName = null;
                let isSettlementFeeActive = false;

                const factorWithVat = 1 + VAT_RATE;
                const denominator = 1 - (SERVICE_RATE * factorWithVat);
                const fixedFeeComponent = FIXED_FEE * factorWithVat;

                let X_intermediate = 0;
                if (P_input > 0 && denominator > 0) {
                    X_intermediate = (P_input + fixedFeeComponent) / denominator;
                } else {
                    X_intermediate = P_input;
                }
                X_intermediate = Math.max(P_input, X_intermediate);


                if (X_intermediate >= SETTLEMENT_THRESHOLD) {
                    actualSettlementOrTransferFee = TRANSFER_FEE_TOTAL;
                    currentSettlementType = 'bank_transfer';
                    providerName = currentLang === 'ar' ? 'تحويل بنكي' : 'Bank Transfer';
                    isSettlementFeeActive = true;
                } else if (X_intermediate > 0) {
                    if (includeSettlementCheckbox.checked) {
                        const selectedProvider = document.querySelector('input[name="provider"]:checked').value;
                        if (selectedProvider === 'tabby') {
                            actualSettlementOrTransferFee = SETTLEMENT_TABBY;
                            providerName = i18n[currentLang]?.providerTabbyLabel.split('(')[0].trim() || 'Tabby';
                        } else {
                            actualSettlementOrTransferFee = SETTLEMENT_TAMARA;
                            providerName = i18n[currentLang]?.providerTamaraLabel.split('(')[0].trim() || 'Tamara';
                        }
                        currentSettlementType = 'provider_settlement';
                        isSettlementFeeActive = true;
                    } else {
                        actualSettlementOrTransferFee = 0;
                        currentSettlementType = 'provider_settlement';
                        isSettlementFeeActive = false;
                         const selectedProvider = document.querySelector('input[name="provider"]:checked').value;
                         providerName = selectedProvider === 'tabby' ? (i18n[currentLang]?.providerTabbyLabel.split('(')[0].trim() || 'Tabby') : (i18n[currentLang]?.providerTamaraLabel.split('(')[0].trim() || 'Tamara');
                    }
                } else {
                     actualSettlementOrTransferFee = 0;
                     currentSettlementType = null;
                     isSettlementFeeActive = false;
                }


                if (P_input > 0 && denominator > 0) {
                    X_calc = (P_input + fixedFeeComponent + actualSettlementOrTransferFee) / denominator;
                    X_calc = Math.max(P_input, X_calc);

                    if (X_calc >= 0.01) {
                        baseFee_calc = (X_calc * SERVICE_RATE) + FIXED_FEE;
                        vat_calc = baseFee_calc * VAT_RATE;
                        totalServiceFee_calc = baseFee_calc + vat_calc;
                    } else {
                        X_calc = P_input;
                        baseFee_calc = 0;
                        vat_calc = 0;
                        totalServiceFee_calc = 0;
                        if (P_input === 0) {
                            actualSettlementOrTransferFee = 0;
                            isSettlementFeeActive = false;
                            currentSettlementType = null;
                        }
                    }
                } else {
                    X_calc = P_input;
                    baseFee_calc = 0;
                    vat_calc = 0;
                    totalServiceFee_calc = 0;
                    actualSettlementOrTransferFee = 0;
                    isSettlementFeeActive = false;
                    currentSettlementType = null;
                }
                
                X_calc = Math.max(0, X_calc);
                baseFee_calc = Math.max(0, baseFee_calc);
                vat_calc = Math.max(0, vat_calc);
                totalServiceFee_calc = Math.max(0, totalServiceFee_calc);
                actualSettlementOrTransferFee = Math.max(0, actualSettlementOrTransferFee);

                return {
                    P_input: P_input,
                    X: X_calc,
                    baseFee: baseFee_calc,
                    vat: vat_calc,
                    totalServiceFee: totalServiceFee_calc,
                    S_final: actualSettlementOrTransferFee,
                    settlementType: currentSettlementType,
                    providerForSettlement: providerName,
                    settlementFeeActive: isSettlementFeeActive && actualSettlementOrTransferFee > 0
                };
            }


             // --- Update UI with Calculations (MODIFIED) ---
             function updateUIWithCalculations() {
                 if (!providerCard || !priceInput) return;
                 const { P_input, X, baseFee, vat, totalServiceFee, S_final, settlementType } = currentCalculations;
                 const langData = i18n[currentLang];
                 const suffix = langData?.currencySuffix || 'SAR';

                 const settlementFeeLabelEl = settlementFeeRow?.querySelector('.label[data-key="settlementFeeLabel"]');
                 if (settlementFeeLabelEl) {
                    let labelTextKey = 'settlementFeeLabel_provider';
                    if (settlementType === 'bank_transfer') {
                        labelTextKey = 'settlementFeeLabel_transfer';
                    }
                    settlementFeeLabelEl.textContent = langData[labelTextKey] + ' ';
                 }


                 const updateValueField = (selector, newValue) => {
                     const el = providerCard.querySelector(selector);
                     if (el) {
                         const displayValue = `${formatNumber(newValue)}${suffix}`;
                         el.textContent = displayValue;
                         el.dataset.rawValue = newValue;
                     }
                 };
                 updateValueField('.base', baseFee);
                 updateValueField('.vat', vat);
                 updateValueField('.serviceFee', totalServiceFee);
                 updateValueField('.settlementFee', S_final);
                 updateValueField('.charge', X);
                 updateValueField('.net', P_input);

                 const totalFeesCalculated = totalServiceFee + S_final;
                 const profitPercentage = X > 0 ? (P_input / X * 100) : (P_input > 0 ? 100 : 0);
                 const feesPercentage = X > 0 ? (totalFeesCalculated / X * 100) : 0;

                 const safeProfitPercentage = Math.min(100, Math.max(0, profitPercentage));
                 const safeFeesPercentage = Math.min(100, Math.max(0, feesPercentage));

                 updateAttribute('.viz-bar-profit', 'style', `flex-basis: ${safeProfitPercentage}%`, providerCard);
                 updateAttribute('.viz-bar-fees', 'style', `flex-basis: ${safeFeesPercentage}%`, providerCard);
                 providerCard.querySelectorAll('li.detail-row.expanded').forEach(updateCalculationDetails);
                 updateClearButtonState();
             }


             // --- Main Calculation Trigger (Unchanged) ---
             function calculateFees() {
                 const raw = priceInput?.value.replace(/[^0-9.]/g, '');
                 const P_in = parseFloat(raw) || 0;
                 currentCalculations = performCalculations(P_in);
                 updateUIWithCalculations();
             }

             // --- Clear Button State (Unchanged) ---
             function updateClearButtonState() { if (!btnClear || !priceInput) return; const hasContent = priceInput.value.replace(/[^0-9.]/g, '').length > 0; btnClear.disabled = !hasContent; }

            // --- Details Update (MODIFIED) ---
            function updateCalculationDetails(detailListItem) {
                if (!detailListItem) return;
                const type = detailListItem.dataset.detailsType;
                const container = detailListItem.querySelector('.calculation-details');
                const langData = i18n[currentLang];
                const func = langData?.calculationDetails?.[type];

                if (container) container.innerHTML = '';

                if (func && container && langData) {
                    let html = '';
                    const { P_input, X, baseFee, vat, totalServiceFee, S_final, settlementType, providerForSettlement, settlementFeeActive } = currentCalculations;
                    const suffix = langData.currencySuffix || 'SAR';
                    const fX = formatNumber(X);
                    const fB = formatNumber(baseFee);
                    const fV = formatNumber(vat);
                    const fS_final = formatNumber(S_final);
                    const fTSF = formatNumber(totalServiceFee);
                    const fP_input = formatNumber(P_input);

                    try {
                        switch (type) {
                            case 'baseFee': html = func(fX, fB, suffix); break;
                            case 'vat': html = func(fB, fV, suffix); break;
                            case 'settlementFee':
                                html = func(settlementType, providerForSettlement, fS_final, suffix, settlementFeeActive, X);
                                break;
                            case 'totalServiceFee': html = func(fB, fV, fTSF, suffix); break;
                            case 'netProfit': html = func(fP_input, suffix); break;
                        }
                        container.innerHTML = html;
                    } catch (e) {
                        console.error("Error generating calculation details for type:", type, e);
                        container.innerHTML = 'Error loading details.';
                    }
                }
            }


             // --- Event Listener Setup ---
             function setupEventListeners() {
                 if (priceInput) { priceInput.addEventListener('blur', () => { const raw = priceInput.value.replace(/[^0-9.]/g, ''); const num = parseFloat(raw) || 0; priceInput.value = num > 0 ? formatNumber(num) : ''; calculateFees(); }); priceInput.addEventListener('input', debounce(calculateFees, 250)); priceInput.addEventListener('focus', () => { const raw = priceInput.value.replace(/[^0-9.]/g, ''); priceInput.value = raw; priceInput.select(); updateClearButtonState(); }); priceInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); priceInput.blur(); } }); }
                 btnTheme?.addEventListener('click', toggleTheme); btnLang?.addEventListener('click', switchLang); btnPrint?.addEventListener('click', () => window.print());
                 btnShareWhatsapp?.addEventListener('click', () => { try { const lang = i18n[currentLang]; if (!lang) throw new Error("Lang"); const { P_input, X } = currentCalculations; const cur = lang.currencySuffix?.trim() ?? 'SAR'; const f = (n)=>{const fm=formatNumber(n); return fm.includes('e')?fm:`${fm} ${cur}`}; const pF=f(P_input), xF=f(X); const msg = lang.shareMessageTemplate?.replace('{P}',pF)?.replace('{X}',xF)?.replace(/{C}/g,cur)??`Calc: P=${pF}, X=${xF}`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank', 'noopener,noreferrer'); } catch (e) { console.error("Share err:", e); alert("Share failed."); } });
                 if (btnClear && priceInput) { let timer=null, isLong=false; const dur=500; const del=()=>{if(btnClear.disabled) return; const v=priceInput.value;if(v.length>0){priceInput.value=v.slice(0,-1);calculateFees();}}; const clear=()=>{if(btnClear.disabled) return; priceInput.value='';calculateFees(); }; const start=(e)=>{e.preventDefault();if(btnClear.disabled) return; isLong=false;clearTimeout(timer);timer=setTimeout(()=>{isLong=true;clear();if(navigator.vibrate)navigator.vibrate(50);},dur);}; const end=(e)=>{e.preventDefault();if(btnClear.disabled) return; clearTimeout(timer);if(!isLong)del();}; const cancel=()=>{clearTimeout(timer);}; btnClear.addEventListener('mousedown',start);btnClear.addEventListener('mouseup',end);btnClear.addEventListener('mouseleave',cancel);btnClear.addEventListener('touchstart',start,{passive:false});btnClear.addEventListener('touchend',end);btnClear.addEventListener('touchcancel',cancel);btnClear.addEventListener('contextmenu',(e)=>e.preventDefault()); }

                providerTabbyRadio?.addEventListener('change', calculateFees);
                providerTamaraRadio?.addEventListener('change', calculateFees);
                includeSettlementCheckbox?.addEventListener('change', calculateFees);


                 // Expand Delegation (Unchanged)
                 providerCard?.addEventListener('click', (event) => {
                     const mainToggleLi = event.target.closest('li.main-result-toggle');
                     const detailLi = event.target.closest('li.detail-row.expandable');
                     if (mainToggleLi && event.target.closest('.result-row, .toggle-details-button')) {
                         if (!event.target.closest('.detail-row')) {
                            mainToggleLi.classList.toggle('details-expanded');
                            updateToggleDetailsButtonText();
                         }
                     }
                     else if (detailLi && event.target.closest('.result-row')) {
                         if (!event.target.closest('.calculation-details')) {
                            event.stopPropagation();
                            detailLi.classList.toggle('expanded');
                            if (detailLi.classList.contains('expanded')) {
                                 updateCalculationDetails(detailLi);
                             }
                          }
                     }
                 });

                 // Media Query Listeners for Lang Button Text
                 const responsiveHandler = debounce(() => {
                    updateLangButtonVisuals();
                 }, 150);
                 mobileMediaQuery.addEventListener('change', responsiveHandler);
             }

             // --- Initialization ---
             function initialize() {
                 if (yearEl) yearEl.textContent = new Date().getFullYear();
                 providerCard?.querySelectorAll('.value').forEach(el => { el.dataset.rawValue = '0'; });
                 applyTheme();
                 applyLang();
                 setupEventListeners();
                 const sidebarEl = document.querySelector('.sidebar');
                 const mainContentEl = document.querySelector('.main-content-area');
                 requestAnimationFrame(() => {
                    if (sidebarEl) sidebarEl.style.animationPlayState = 'running';
                    if (mainContentEl) mainContentEl.style.animationPlayState = 'running';
                 });
             }

             // Run Init
             initialize();
         });
     </script>

</body>
</html>
